<!doctype html>
<html lang='en'>

<head>
  <title>ove-jupyter overview</title>
  <link rel='shortcut icon' href='#'>
  <style>
      .markdown-body {
          background-color: white;
          display: flex;
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
          flex-direction: column;
          align-items: center;
      }

      .markdown-body table td, .markdown-body table th {
          border: none;
      }

      .dataTables_paginate, .dataTables_info, .dataTables_length {
          font-size: 12px;
      }

      .dataTables_length {
          padding-top: 0.5em;
      }

      .client {
          fill: lightgrey;
          stroke: black;
          stroke-width: 1px;
      }

      #sections {
          width: calc(100% - 100px);
      }

      .section {
          stroke: none;
          opacity: 0.7;
          stroke-width: 0;
      }

      .section-label, .space-label {
          fill: white;
      }

  </style>

  <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.4/d3.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/jquery.dataTables.min.js'></script>

  <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/css/jquery.dataTables.min.css">
  <script>
      const observatoryName = "";
      const observatory = {};
      const sections = [];

      const loadState = () => {
          $.fn.dataTable.ext.errMode = 'none';
          drawSpace();
          tabulateSections();
      };

      const drawSpace = () => {
          const margin = 50;
          const width = window.innerWidth - 2 * margin;
          const height = window.innerHeight - 2 * margin;

          d3.selectAll('#observatory>div').remove();

          let spaceNames = observatoryName;

          let scaleFactor = Math.max((observatory["height"] / height), (observatory["width"] / width));

          let x = d3.scaleLinear().range([0, width]).domain([0, width * scaleFactor]);
          let y = d3.scaleLinear().range([0, height]).domain([0, height * scaleFactor]);

          let divs = d3.select('#observatory')
              .selectAll('div')
              .data([spaceNames])
              .enter()
              .append('div');

          divs.append('h3').html(d => `${d}`);

          // Create an SVG for each space, setting width and height separately
          let svgs = divs.append('svg')
              .attr('width', () => x(observatory["width"]))
              .attr('height', () => y(observatory["height"]));
          const cells = Array.from({length: observatory["columns"] * observatory["rows"]}, (_x, i) => i);
          const cellWidth = observatory["width"] / observatory["columns"];
          const cellHeight = observatory["height"] / observatory["rows"];

          svgs.selectAll('rect')
              .data(() => cells)
              .enter()
              .append('rect')
              .attr('x', (_d, i) => x(cellWidth * (i % observatory["columns"])))
              .attr('y', (_d, i) => y(cellHeight * (Math.floor(i / observatory["columns"]))))
              .attr('width', () => x(cellWidth))
              .attr('height', () => y(cellHeight))
              .classed('client', true)
              .append('title')
              .text((_d, i) => 'Client Id: ' + i);

          const cellTextSize = Math.min(cellHeight, cellWidth) / 4;
          svgs.selectAll('.space-label')
              .data(() => cells)
              .enter()
              .append('text')
              .text((_d, i) => i)
              .attr('x', (_d, i) => (x(cellWidth * (i % observatory["columns"]) + cellWidth / 2) - cellTextSize * 0.25))
              .attr('y', (_d, i) => (y(cellHeight * (Math.floor(i / observatory["columns"])) + cellHeight / 2) + cellTextSize * 0.5))
              .style('font-size', cellTextSize + 'px')
              .classed('space-label', true);

          const colors = ['dodgerblue', 'crimson', 'darkorange', 'darkviolet', '#4daf4a'];
          svgs.selectAll('.sections')
              .data(() => sections)
              .enter()
              .append('rect')
              .attr('x', d => x(d.x * observatory["width"]))
              .attr('y', d => y(d.y * observatory["height"]))
              .attr('width', d => x(d.width * observatory["width"]))
              .attr('height', d => y(d.height * observatory["height"]))
              .style('fill', (_d, i) => colors[i % colors.length])
              .classed('section', true)
              .append('title')
              .text((_d, i) => 'Section Id: ' + i);

          const minSectionHeight = d3.min(sections.map(d => y(d.height * observatory["height"])));
          const minSectionWidth = d3.min(sections.map(d => x(d.width * observatory["width"])));
          const sectionTextSize = Math.min(minSectionHeight, minSectionWidth) / 4;
          svgs.selectAll('.section-label')
              .data(() => sections)
              .enter()
              .append('text')
              .text((_d, i) => i)
              .attr('x', d => (x((d.x + d.width / 2) * observatory["width"]) - sectionTextSize * 0.25))
              .attr('y', d => (y((d.y + d.height / 2) * observatory["height"]) + sectionTextSize * 0.5))
              .style('font-size', sectionTextSize + 'px')
              .classed('section-label', true);
      };

      const tabulateSections = () => {
          const appNames = sections.map(({dataType}) => dataType);
          createSectionsTables(appNames);
      };

      function createSectionsTables(appNames) {
          let spaceNames = [observatoryName];

          let divs = d3.select('#sections')
              .selectAll('div')
              .data(spaceNames)
              .enter();

          const blocks = divs.append('div');

          blocks.append('h3').text(d => d);

          const columns = ['id', 'x', 'y', 'width', 'height', 'data type'];

          const convert = (d, i) => [
              i,
              `${(d.x * 100).toFixed(2)}%`,
              `${(d.y * 100).toFixed(2)}%`,
              `${(d.width * 100).toFixed(2)}%`,
              `${(d.height * 100).toFixed(2)}%`,
              appNames[i]
          ];

          const tables = blocks.append('table')
              .attr('class', 'dataTable display cell-border no-footer')
              .attr('style', 'display:table')
              .attr('id', d => `section-table-${d}`);

          tables.append("thead")
              .selectAll("th")
              .data(columns)
              .enter("th")
              .text(d => d);
          tables.append("tbody");

          spaceNames.map(spaceName => {
              const values = sections.map(convert);

              $(`#section-table-${spaceName}`).DataTable({
                  data: values,
                  columns: columns.map(d => ({title: d}))
              });
          });
      }
  </script>

</head>
<body class='markdown-body' onload='loadState()' onresize='loadState()'>
<h2>Sections</h2>
<div id='sections'></div>


<h2>Layout Preview</h2>
<div id='observatory'></div>

</body>

</html>